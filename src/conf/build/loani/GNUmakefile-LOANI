TOP = ..

include $(TOP)/GNUmakevars.inc


LOANI_REPOSITORY_DIR = LOANI-repository
LOANI_INSTALL_DIR = LOANI-installations


LOANI_FELLOWS_FILES =   loani.sh loani-requiredTools.sh loani-commonBuildTools.sh   \
			loani-optionalTools.sh loani-versions.sh                    \
			defaultLocations.sh termUtils.sh platformDetection.sh       \
			generateBugReport.sh makeRepositoryLinks.sh $(LOANI_README_TARGET)


LOANI_VERSION = $(VERSION)

LOANI_ARCHIVE_NAME = LOANI-$(LOANI_VERSION)
 
LOANI_ZIP = $(LOANI_ARCHIVE_NAME).zip
LOANI_TGZ = $(LOANI_ARCHIVE_NAME).tar.gz

LOANI_TMP_ARCHIVE_DIR = $(LOANI_ARCHIVE_NAME)


CEYLAN_RELEASE := $(ARCHIVEROOT)/Ceylan/Ceylan-${CEYLAN_VERSION}/$(CEYLAN_SRC_RELEASE_ARCHIVE_NAME)

OSDL_RELEASE := $(ARCHIVEDIR)/$(SRC_RELEASE_ARCHIVE_NAME)

LOANI_README_TEMPLATE := LOANI-README-template.txt
LOANI_README_TARGET   := README


.PHONY: release blank-MD5 links mktmpdir updateREADME test info clean realclean 


release: links $(LOANI_TGZ) $(LOANI_ZIP) 
	@echo "@OSDL_MAKE_STYLE@    Release archives for LOANI are available.@OSDL_DEFAULT_STYLE@"
	
blank-MD5:
	@echo "@OSDL_INSTALL_STYLE@    Blanking MD5 sum of OSDL release to avoid MD5 recursive dependency on archive@OSDL_DEFAULT_STYLE@"
	@../../../../Ceylan/Ceylan-${CEYLAN_VERSION}/src/code/scripts/shell/replaceLineStartingBy.sh OSDL_MD5 'OSDL_MD5="(blanked)"' osdl-versions.sh 

	
links: 
	@ln -sf ../../../../Ceylan/Ceylan-${CEYLAN_VERSION}/src/code/scripts/shell/termUtils.sh
	@ln -sf ../../../../Ceylan/Ceylan-${CEYLAN_VERSION}/src/code/scripts/shell/defaultLocations.sh
	@ln -sf ../../../../Ceylan/Ceylan-${CEYLAN_VERSION}/src/code/scripts/shell/makeRepositoryLinks.sh
	
	
$(LOANI_ZIP): $(LOANI_FELLOWS_FILES) $(LOANI_README_TEMPLATE)
	@$(MAKE) mktmpdir
	@echo "@OSDL_MAKE_STYLE@    Building LOANI release file $@@OSDL_DEFAULT_STYLE@"
	@zip $@ $(LOANI_TMP_ARCHIVE_DIR)/* 1>/dev/null 2>&1
	
			
$(LOANI_TGZ): $(LOANI_FELLOWS_FILES) $(LOANI_README_TEMPLATE)
	@$(MAKE) mktmpdir
	@echo "@OSDL_MAKE_STYLE@    Building LOANI release file $@@OSDL_DEFAULT_STYLE@"
	@tar chf - $(LOANI_TMP_ARCHIVE_DIR) | gzip > $@


mktmpdir: $(LOANI_README_TARGET)
	-@rm -rf $(LOANI_TMP_ARCHIVE_DIR)
	@mkdir $(LOANI_TMP_ARCHIVE_DIR)
	@cp -f $(LOANI_FELLOWS_FILES) $(LOANI_TMP_ARCHIVE_DIR)
	@chmod +x $(LOANI_TMP_ARCHIVE_DIR)/loani.sh
		

$(LOANI_README_TARGET): $(TOP)/GNUmakevars.inc
	@cat $(LOANI_README_TEMPLATE) | sed 's|PG_VERSION|$(LOANI_VERSION)|g' | sed "s|PG_DATE|`date '+%A, %B %e, %Y (%H:%M)'`|g"> $@


loani-versions.sh: $(CEYLAN_VERSIONS) osdl-versions.sh $(CEYLAN_RELEASE) $(OSDL_RELEASE)
	@echo "@OSDL_MAKE_STYLE@    Merging $@@OSDL_DEFAULT_STYLE@"
	@echo "# This file tells LOANI and the build system about the tools that they must know." > $@
	@echo "# It corresponds to the gathering of Ceylan and OSDL related tools." >> $@
	@echo "# " >> $@
	@echo "# This file is generated, hence should *not* be modified :" >> $@
	@echo "# modify instead" `basename $(CEYLAN_VERSIONS)` "and osdl-versions.sh." >> $@
	@echo >> $@
	@cat $(CEYLAN_VERSIONS) osdl-versions.sh >> $@
	@./updateLOANI-MD5.sh $(CEYLAN_RELEASE) $(OSDL_RELEASE)\
	../../../../Ceylan/Ceylan-${CEYLAN_VERSION}/src/code/scripts/shell/replaceLineStartingBy.sh

	
test: release
	@mkdir -p $(HOME)/tmp/LOANI-testing
	@cp -f $(LOANI_ZIP) $(LOANI_TGZ) $(HOME)/tmp/LOANI-testing
	@cd $(HOME)/tmp/LOANI-testing; unzip -qq $(LOANI_ZIP)
	@echo "You can type now : cd $(HOME)/tmp/LOANI-testing; loani.sh -d --sourceforge <your user>"


info:
	@echo "LOANI_VERSION       = $(LOANI_VERSION)"
	@echo "LOANI_ZIP           = $(LOANI_ZIP)" 
	@echo "LOANI_TGZ           = $(LOANI_TGZ)"
	@echo "LOANI_FELLOWS_FILES = $(LOANI_FELLOWS_FILES)"
	@echo "Ceylan release      = $(CEYLAN_RELEASE)"
	@echo "OSDL release        = $(OSDL_RELEASE)"
	

stat:
	@echo "newline, word, and byte counts for LOANI :"
	@cat $(LOANI_FELLOWS_FILES) | wc
		
		
clean:
	@echo "@OSDL_CLEAN_STYLE@    Cleaning all in `pwd`@OSDL_DEFAULT_STYLE@"
	-@rm -f wget-log* LOANI.log $(LOANI_ZIP) $(LOANI_TGZ)\
	$(LOANI_README_TARGET) loani-versions.sh
	-@rm -rf LOANI-$(LOANI_VERSION)
	
	
realclean : clean
	@echo "@OSDL_CLEAN_STYLE@    Real cleaning all in `pwd`@OSDL_DEFAULT_STYLE@"
	-@rm -rf $(LOANI_REPOSITORY_DIR) $(LOANI_INSTALL_DIR)	
	-@rm -f  $(LOANI_TGZ) $(LOANI_ZIP) 
	
